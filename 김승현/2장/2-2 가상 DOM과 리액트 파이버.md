# 2.2 가상 DOM과 리액트 파이버

## DOM

    Document Object Model의 약자로, 문서 객체 모델이라는 의미를 갖는다. 이는 브라우저 상에서 자바스크립트가 html 문서를 조작하기 위한 API이다. js가 직접 html을 동적으로 바꾸는데 한계가 있으니, js가 조작하기 편하게 DOM이라는 형태로 바꾸어놓은 것이라고 할 수 있다. js가 html을 조작해야하는 이유는 다양하고 복잡한 인터랙션을 만들고 화면을 구현하기 위해 필요한 작업이다.

    브라우저가 렌더링을 하는 과정을 살펴보면, 네트워크를 통해 html 문서를 불러오는데, 아직은 raw byte에 불과하기때문에 브라우저가 읽기 쉽지않다. 따라서 characterize화를 하여 읽기 쉽도록 변환을 해준 후, 이를 tokenize화 해준다. 그리고 이를 nodes로 바꿔준 후 이를 기반으로 DOM Tree를 생성해준다.

    따라서 결국 DOM은 html로부터 온것이라고 할 수 있다.


    그렇다면 그냥 이 DOM을 활용하여 html을 조작하면 되는데, 굳이 허상으로 만들어서 가상 DOM을 만든 이유는 무엇일까?

## 가상 DOM (Virtual DOM)

    가상돔의 동작원리는 다음과 같다.

1. real DOM으로부터 virtual DOM을 만든다(virtual DOM은 메모리 상에 존재하는 하나의 객체다)
2. 변화가 생기면 새로운 버전의 virtual DOM을 만든다.
3. old 버전의 virtual DOM과 new 버전의 virtual DOM을 비교한다.(diff algorithm)
4. 비교 과정을 통해서 발견한 차이점을 real DOM에 적용한다.

   virtual DOM은 메모리 상에 존재하는 하나의 객체이다. 리액트는 특정 state에 변화가 생겼다는 알림을 받으면 real DOM 전체를 렌더링 시켜주는 것이 아닌, virtual DOM을 렌더링하게된다.

</br>

## 📌 실제 DOM이 아닌, 가상 DOM을 사용하는 이유

    브라우저를 렌더링 시키는 비용 vs 객체를 새로 만드는 비용

    → 객체를 새로 만드는 비용이 훨씬 저렴하기 때문

    브라우저를 새롭게 렌더링 시키는 비용보다, 객체를 새로 만드는 비용이 훨씬 더 저렴하기 때문에 리액트는 이렇게 변화가 감지되면 real DOM을 새롭게 렌더링 시키는 대신, virtual DOM이라는 메모리상의 객체를 새로 만드는 방식을 선택하였고 거기서 변화가 생긴 내용을 비교하여 마지막에 가서는 꼭 필요한 부분만 real DOM에 적용시키는 방식으로 효율성을 높이게 되었다.

    실제로 전체화면을 렌더링하는 것과 일부분만 변경시켜주는 것은 비용적인 측면에서 엄청난 차이가 있기 때문에, 실제 DOM을 직접 조작하는 것보다, 가상 DOM을 이용하는 것이 더 효율적인 방식이다.

</br>

## 리액트 파이버의 등장

    이전 과정의 한계 :

    가상 돔이 동작하는 과정을 살펴보면, 다음과 같다.

    1. real DOM으로부터 virtual DOM을 만든다(virtual DOM은 메모리 상에 존재하는 하나의 객체다)
    2. 변화가 생기면 새로운 버전의 virtual DOM을 만든다.
    3. **old 버전의 virtual DOM과 new 버전의 virtual DOM을 비교한다.(diff algorithm)**
    4. 비교 과정을 통해서 발견한 차이점을 real DOM에 적용한다.


    3번 과정에서 한가지 문제가 발생하게된다. 두 virtual tree는 객체로 만들어져있고, 이 둘의 차이를 찾기위해 diff 알고리즘이 진행되며 이때 두 객체를 비교하기 위해서는 재귀적으로 진행할 수 밖에 없다.

    call stack에 쌓여있는 모든 함수들이 return될때까지 call stack을 비워주지 않는다. 이는 결국 재귀적으로 tree를 순회하는 시간이 16ms를 넘어서면, 프레임 드롭이 발생할 뿐만 아니라, 어플의 크기에 따라 순회하는 시간이 길어지면 유저 이벤트에 즉각적으로 대응하는 것이 어려워진다.

    이때 react fiber가 등장하였고, 리액트 파이버가 해결하고자 하는 것은 이런 순회 작업을 멈출 수도, 재개할수도, 필요에 따라서는 그냥 버릴수도 있게 만드는 것이라고 할 수 있다.

참고 : [https://velog.io/@yesbb/virtual-DOM의-성능이-더-좋은이유](https://velog.io/@yesbb/virtual-DOM%EC%9D%98-%EC%84%B1%EB%8A%A5%EC%9D%B4-%EB%8D%94-%EC%A2%8B%EC%9D%80%EC%9D%B4%EC%9C%A0)

</br>
